# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting on PR

on: pull_request

permissions:
  checks: write
  contents: read
  pull-requests: write

jobs:
  notify-start:
    runs-on: ubuntu-latest
    steps:
      - name: Notify Telegram - Workflow Started
        run: |
          MESSAGE="ðŸš€ Novidades! Um deploy de preview do frontend web do Tharseo foi iniciado para o PR #${{ github.event.number }}... A previsÃ£o do tÃ©rmino Ã© de 3 minutos."
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="${MESSAGE}" \
            -d parse_mode="Markdown"

  build_and_preview:
    if: ${{ github.event.pull_request.head.repo.full_name == github.repository }}
    needs: notify-start
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - run: npm ci --legacy-peer-deps && npm run build --legacy-peer-deps
      - uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_THARSEO_C8CB9 }}
          projectId: tharseo-c8cb9
      
      - name: ZAP Scan
        uses: zaproxy/action-full-scan@v0.10.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          docker_name: 'ghcr.io/zaproxy/zaproxy:stable'
          target: 'https://tharseocripto.web.app/'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a'
          allow_issue_writing: false
          artifact_name: 'zap_scan_report'

      - name: Notify Telegram - Deploy Success
        if: success()
        run: |
          MESSAGE="âœ… Preview do frontend do Tharseo para o PR #${{ github.event.number }} realizado com sucesso! Verifique o resultado no Firebase Hosting em https://tharseocripto.web.app."
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="${MESSAGE}" \
            -d parse_mode="Markdown"

      - name: Notify Telegram - Deploy Failure
        if: failure()
        run: |
          MESSAGE="ðŸš¨ Ocorreu um erro durante o deploy de preview do frontend do Tharseo para o PR #${{ github.event.number }}. Verifique os logs do actions para maiores informaÃ§Ãµes."
          curl -s -X POST https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMessage \
            -d chat_id=${{ secrets.TELEGRAM_CHAT_ID }} \
            -d text="${MESSAGE}" \
            -d parse_mode="Markdown"
